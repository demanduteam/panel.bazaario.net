<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Product Management - Bazaario</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        vazir: ['Vazirmatn', 'sans-serif'],
                    },
                    keyframes: {
                        shimmer: {
                          '100%': { transform: 'translateX(100%)' },
                        },
                    },
                },
            },
        }
    </script>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script src="https://cdn.jsdelivr.net/npm/jalaali-js/dist/jalaali.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap');
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.3s ease-in-out;
        }
        .modal-content {
            padding: 1.5rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            transition: transform 0.3s ease-in-out;
        }
        .modal-overlay.open .modal-content {
            transform: scale(1);
        }
        .modal-content::-webkit-scrollbar { width: 8px; }
        .dark .modal-content::-webkit-scrollbar-track { background: #2d3748; }
        .dark .modal-content::-webkit-scrollbar-thumb { background-color: #4a5568; border-radius: 10px; border: 2px solid #2d3748; }
        .light .modal-content::-webkit-scrollbar-track { background: #e5e7eb; }
        .light .modal-content::-webkit-scrollbar-thumb { background-color: #9ca3af; border-radius: 10px; border: 2px solid #e5e7eb; }
        
        .spinner {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #3498db;
            border-radius: 50%;
            width: 14px;
            height: 14px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        // ==================================================
        // Supabase Client Setup
        // ==================================================
        const { createClient } = supabase;
        const supabaseUrl = 'https://wehyjatotbzxargnxasg.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndlaHlqYXRvdGJ6eGFyZ254YXNnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE5MTIwMjEsImV4cCI6MjA2NzQ4ODAyMX0.2R448DuEBlTrNvaYXiYZ8D5M7MJNv7n1qmIDHQBNFiY';
        const supabaseClient = createClient(supabaseUrl, supabaseKey, { global: { fetch: window.fetch.bind(window) } });

        // ==================================================
        // Helper Functions & UI Components
        // ==================================================

        const toJalaali = (isoString) => {
            if (!isoString) return '-';
            try {
                const date = new Date(isoString);
                const { jy, jm, jd } = jalaali.toJalaali(date.getFullYear(), date.getMonth() + 1, date.getDate());
                const pad = (num) => String(num).padStart(2, '0');
                return `${jy}/${pad(jm)}/${pad(jd)}`;
            } catch (e) {
                return '-';
            }
        };

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="modal-overlay open" onClick={onClose}>
                    <div className="modal-content bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-4 pb-3 border-b border-gray-200 dark:border-gray-600">
                            <h2 className="text-xl font-bold">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-800 dark:hover:text-white text-2xl">&times;</button>
                        </div>
                        {children}
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, onClose, onConfirm, title, message }) => {
            if (!isOpen) return null;
            return (
                <Modal isOpen={isOpen} onClose={onClose} title={title}>
                    <p className="text-gray-600 dark:text-gray-300 mb-6">{message}</p>
                    <div className="flex flex-col sm:flex-row justify-end gap-3">
                        <button type="button" onClick={onClose} className="w-full sm:w-auto bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-700 text-gray-800 dark:text-white font-bold py-2 px-4 rounded-lg">لغو</button>
                        <button type="button" onClick={onConfirm} className="w-full sm:w-auto bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">تایید</button>
                    </div>
                </Modal>
            );
        };

        const SearchableSelect = ({ options, value, onChange, placeholder }) => {
            const [isOpen, setIsOpen] = React.useState(false);
            const [searchTerm, setSearchTerm] = React.useState('');
            const ref = React.useRef(null);

            React.useEffect(() => {
                const handleClickOutside = (event) => {
                    if (ref.current && !ref.current.contains(event.target)) {
                        setIsOpen(false);
                        setSearchTerm('');
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, [ref]);

            const selectedOption = React.useMemo(() => options.find(option => option.id == value), [options, value]);

            const filteredOptions = React.useMemo(() => {
                if (!searchTerm) return options;
                return options.filter(option =>
                    option.title.toLowerCase().includes(searchTerm.toLowerCase())
                );
            }, [options, searchTerm]);

            const handleSelect = (optionId) => {
                onChange(optionId);
                setIsOpen(false);
                setSearchTerm('');
            };

            const handleInputChange = (e) => {
                setSearchTerm(e.target.value);
                if (!isOpen) setIsOpen(true);
            };

            return (
                <div className="relative" ref={ref}>
                    <input
                        type="text"
                        className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg cursor-pointer"
                        value={isOpen ? searchTerm : (selectedOption?.title || '')}
                        onChange={handleInputChange}
                        onFocus={() => setIsOpen(true)}
                        placeholder={placeholder}
                    />
                    {isOpen && (
                        <ul className="absolute z-20 w-full bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-lg mt-1 max-h-60 overflow-y-auto shadow-lg">
                            {filteredOptions.length > 0 ? (
                                filteredOptions.map(option => (
                                    <li
                                        key={option.id}
                                        className="p-2 hover:bg-indigo-100 dark:hover:bg-indigo-700 cursor-pointer"
                                        onClick={() => handleSelect(option.id)}
                                    >
                                        {option.title}
                                    </li>
                                ))
                            ) : (
                                <li className="p-2 text-gray-500">موردی یافت نشد.</li>
                            )}
                        </ul>
                    )}
                </div>
            );
        };

        const ProductForm = ({ isOpen, onClose, onSave, product, appData }) => {
            const { categories, brands } = appData;
            const initialFormData = { title: '', productcategoryid: '', brandid: '' };
            const [formData, setFormData] = React.useState(initialFormData);
            const [properties, setProperties] = React.useState([]);
            const [propertyValues, setPropertyValues] = React.useState({});
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState('');

            React.useEffect(() => {
                if (isOpen) {
                    setError('');
                    setProperties([]);
                    setPropertyValues({});
                    if (product) {
                        setFormData({
                            title: product.title || '',
                            productcategoryid: product.productcategoryid || '',
                            brandid: product.brandid || ''
                        });
                        if(product.productcategoryid) {
                            fetchCategoryProperties(product.productcategoryid);
                        }
                        fetchProductProperties(product.id);
                    } else {
                        setFormData(initialFormData);
                    }
                }
            }, [product, isOpen]);

            const fetchCategoryProperties = async (categoryId) => {
                const { data, error } = await supabaseClient
                    .from('category_propertykey')
                    .select('propertykey(id, title)')
                    .eq('category_id', categoryId);
                if (error) console.error("Error fetching category properties:", error);
                else setProperties(data.map(item => item.propertykey));
            };
            
            const fetchProductProperties = async (productId) => {
                const { data, error } = await supabaseClient
                    .from('productproperty')
                    .select('propertykeyid, value')
                    .eq('productid', productId);
                if(error) console.error("Error fetching product properties:", error);
                else {
                    const values = data.reduce((acc, curr) => {
                        acc[curr.propertykeyid] = curr.value;
                        return acc;
                    }, {});
                    setPropertyValues(values);
                }
            };

            const handleCategoryChange = (categoryId) => {
                setFormData(prev => ({ ...prev, productcategoryid: categoryId }));
                setPropertyValues({});
                if (categoryId) {
                    fetchCategoryProperties(categoryId);
                } else {
                    setProperties([]);
                }
            };
            
            const handlePropertyChange = (propertyKeyId, value) => {
                setPropertyValues(prev => ({...prev, [propertyKeyId]: value}));
            };

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!formData.title || !formData.productcategoryid) {
                    setError('نام محصول و دسته‌بندی اجباری است.');
                    return;
                }
                setIsLoading(true);
                setError('');
                
                const productData = {
                    title: formData.title,
                    productcategoryid: formData.productcategoryid,
                    brandid: formData.brandid || null,
                };

                try {
                    let productId;
                    if (product) { // Update
                        const { data, error } = await supabaseClient.from('product').update(productData).eq('id', product.id).select().single();
                        if (error) throw error;
                        productId = data.id;
                    } else { // Insert
                        const { data, error } = await supabaseClient.from('product').insert(productData).select().single();
                        if (error) throw error;
                        productId = data.id;
                    }
                    
                    if (productId) {
                        await supabaseClient.from('productproperty').delete().eq('productid', productId);

                        const propertiesToInsert = Object.entries(propertyValues)
                            .filter(([key, value]) => value)
                            .map(([propertyKeyId, value]) => ({
                                productid: productId,
                                propertykeyid: parseInt(propertyKeyId),
                                value: value
                            }));
                        
                        if (propertiesToInsert.length > 0) {
                            const { error: insertError } = await supabaseClient.from('productproperty').insert(propertiesToInsert);
                            if (insertError) throw insertError;
                        }
                    }
                    
                    onSave();
                    onClose();
                } catch (err) {
                    console.error("Product save error:", err);
                    setError(err.message || "خطا در ذخیره محصول.");
                } finally {
                    setIsLoading(false);
                }
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={product ? 'ویرایش محصول' : 'افزودن محصول جدید'}>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <div>
                            <label className="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">نام محصول</label>
                            <input type="text" name="title" value={formData.title} onChange={handleChange} className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg" required />
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <label className="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">دسته‌بندی</label>
                                <SearchableSelect
                                    options={categories}
                                    value={formData.productcategoryid}
                                    onChange={handleCategoryChange}
                                    placeholder="جستجو یا انتخاب دسته‌بندی..."
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">برند (اختیاری)</label>
                                 <SearchableSelect
                                    options={brands}
                                    value={formData.brandid}
                                    onChange={(selectedBrandId) => handleChange({ target: { name: 'brandid', value: selectedBrandId }})}
                                    placeholder="جستجو یا انتخاب برند..."
                                />
                            </div>
                        </div>
                        
                        {properties.length > 0 && (
                            <div className="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                                <h3 className="text-lg font-semibold mb-2">ویژگی‌های محصول</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                    {properties.map(prop => (
                                        <div key={prop.id}>
                                            <label className="block text-sm font-medium text-gray-600 dark:text-gray-300 mb-1">{prop.title}</label>
                                            <input
                                                type="text"
                                                value={propertyValues[prop.id] || ''}
                                                onChange={(e) => handlePropertyChange(prop.id, e.target.value)}
                                                className="w-full bg-gray-100 dark:bg-gray-700 p-2 rounded-lg"
                                            />
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {error && <p className="text-red-500 text-sm mt-2 p-2 bg-red-100 dark:bg-red-900/50 rounded-md">{error}</p>}
                        <div className="flex flex-col sm:flex-row justify-end gap-3 pt-4 border-t border-gray-200 dark:border-gray-600">
                            <button type="button" onClick={onClose} className="w-full sm:w-auto bg-gray-200 dark:bg-gray-600 hover:bg-gray-300 dark:hover:bg-gray-700 text-gray-800 dark:text-white py-2 px-4 rounded-lg">لغو</button>
                            <button type="submit" disabled={isLoading} className="w-full sm:w-auto bg-indigo-600 hover:bg-indigo-700 text-white py-2 px-4 rounded-lg disabled:bg-indigo-400">
                                {isLoading ? <div className="spinner mx-auto"></div> : (product ? 'به‌روزرسانی محصول' : 'ایجاد محصول')}
                            </button>
                        </div>
                    </form>
                </Modal>
            );
        };
        
        const ProductDetailsModal = ({ isOpen, onClose, product }) => {
            if (!isOpen || !product) return null;

            const properties = product.productproperty || [];
            const suppliers = product.supplierstock || [];

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`جزئیات محصول: ${product.title}`}>
                    <div className="space-y-6">
                        <div className="p-4 bg-gray-100 dark:bg-gray-700/50 rounded-lg grid grid-cols-1 sm:grid-cols-3 gap-4">
                            <div>
                                <h4 className="text-xs text-gray-500 dark:text-gray-400">نام محصول</h4>
                                <p className="font-semibold">{product.title}</p>
                            </div>
                            <div>
                                <h4 className="text-xs text-gray-500 dark:text-gray-400">برند</h4>
                                <p className="font-semibold">{product.brand?.title || '-'}</p>
                            </div>
                            <div>
                                <h4 className="text-xs text-gray-500 dark:text-gray-400">دسته‌بندی</h4>
                                <p className="font-semibold">{product.productcategory?.title || '-'}</p>
                            </div>
                        </div>

                        {properties.length > 0 && (
                            <div>
                                <h3 className="text-lg font-semibold mb-2">ویژگی‌ها</h3>
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 p-4 bg-gray-50 dark:bg-gray-700/30 rounded-lg">
                                    {properties.map(prop => prop.propertykey && (
                                        <div key={prop.propertykey.id} className="flex justify-between border-b border-gray-200 dark:border-gray-600 py-1">
                                            <span className="text-gray-600 dark:text-gray-400">{prop.propertykey.title}:</span>
                                            <span className="font-semibold">{prop.value}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        <div>
                            <h3 className="text-lg font-semibold mb-2">موجودی تامین‌کنندگان</h3>
                            <div className="space-y-2 max-h-60 overflow-y-auto pr-2">
                                {suppliers.length > 0 ? suppliers.map(stock => (
                                    <div key={stock.supplieruserid} className="p-3 bg-gray-50 dark:bg-gray-700/30 rounded-lg flex justify-between items-center">
                                        <span className="font-semibold">{stock.profiles?.fullname || 'نامشخص'}</span>
                                        <div className="flex gap-4 text-sm">
                                            <span>قیمت: <span className="font-mono">{stock.unitprice ? `${stock.unitprice.toLocaleString('fa-IR')} تومان` : '-'}</span></span>
                                            <span>تعداد: <span className="font-mono">{stock.quantity ?? 'نامحدود'}</span></span>
                                        </div>
                                    </div>
                                )) : (
                                    <p className="text-center text-gray-500 py-4">هیچ تامین‌کننده‌ای برای این محصول موجودی ثبت نکرده است.</p>
                                )}
                            </div>
                        </div>

                         <div className="flex justify-end pt-4 mt-4 border-t border-gray-200 dark:border-gray-600">
                            <button onClick={onClose} className="bg-gray-200 dark:bg-gray-600 py-2 px-5 rounded-lg font-semibold">بستن</button>
                        </div>
                    </div>
                </Modal>
            );
        };

        const GenericManager = ({ onSave, title, tableName, items: initialItems, confirmModal, onManageAttributes, attributeLabel }) => {
            const [items, setItems] = React.useState(initialItems);
            const [newItemName, setNewItemName] = React.useState('');
            const [editingItem, setEditingItem] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(false);
            const [error, setError] = React.useState('');

            React.useEffect(() => { setItems(initialItems); }, [initialItems]);

            const handleAddItem = async (e) => {
                e.preventDefault();
                if (!newItemName.trim()) return;
                setIsLoading(true);
                setError('');

                const { data, error } = await supabaseClient.from(tableName).insert({ title: newItemName.trim() }).select().single();
                if (error) {
                    setError(`خطا در افزودن: ${error.message}`);
                } else {
                    setItems(prev => [...prev, data]);
                    setNewItemName('');
                    onSave();
                }
                setIsLoading(false);
            };

            const handleUpdateItem = async () => {
                if (!editingItem || !editingItem.title.trim()) return;
                setIsLoading(true);
                setError('');

                const { error } = await supabaseClient.from(tableName).update({ title: editingItem.title.trim() }).eq('id', editingItem.id);
                if (error) {
                    setError(`خطا در به‌روزرسانی: ${error.message}`);
                } else {
                    setItems(prev => prev.map(item => item.id === editingItem.id ? editingItem : item));
                    setEditingItem(null);
                    onSave();
                }
                setIsLoading(false);
            };

            const requestDeleteItem = (item) => {
                confirmModal({
                    isOpen: true,
                    message: `آیا از حذف "${item.title}" اطمینان دارید؟ این عمل ممکن است باعث خطا در موارد مرتبط شود.`,
                    onConfirm: () => executeDeleteItem(item.id)
                });
            };

            const executeDeleteItem = async (itemId) => {
                setIsLoading(true);
                setError('');
                const { error } = await supabaseClient.from(tableName).delete().eq('id', itemId);
                if (error) {
                    setError(`خطا در حذف. ممکن است این مورد توسط آیتم دیگری استفاده شده باشد.`);
                } else {
                    setItems(prev => prev.filter(item => item.id !== itemId));
                    onSave();
                }
                setIsLoading(false);
            };
            
            return (
                <div className="space-y-4 bg-white dark:bg-gray-800 p-4 rounded-lg shadow">
                    <h2 className="text-xl font-bold mb-4">{`لیست ${title}`}</h2>
                    <form onSubmit={handleAddItem} className="flex gap-2">
                        <input type="text" value={newItemName} onChange={(e) => setNewItemName(e.target.value)} placeholder={`افزودن ${title} جدید...`} className="flex-grow bg-gray-100 dark:bg-gray-700 p-2 rounded-lg" />
                        <button type="submit" disabled={isLoading} className="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg disabled:bg-green-400">افزودن</button>
                    </form>
                    {error && <p className="text-red-500 text-sm">{error}</p>}
                    <div className="max-h-96 overflow-y-auto space-y-2 pr-2">
                        {items.map(item => (
                            <div key={item.id} className="flex items-center justify-between p-2 bg-gray-50 dark:bg-gray-700/50 rounded-md">
                                {editingItem?.id === item.id ? (
                                    <input type="text" value={editingItem.title} onChange={(e) => setEditingItem({ ...editingItem, title: e.target.value })} className="flex-grow bg-white dark:bg-gray-600 p-1 rounded-md" autoFocus onBlur={handleUpdateItem} onKeyDown={e => e.key === 'Enter' && handleUpdateItem()} />
                                ) : ( <span className="text-gray-800 dark:text-gray-200">{item.title}</span> )}
                                <div className="flex-shrink-0 space-x-2 space-x-reverse">
                                    {onManageAttributes && (<button onClick={() => onManageAttributes(item)} className="text-sm text-green-500 hover:underline">{attributeLabel || 'مدیریت'}</button>)}
                                    {editingItem?.id === item.id ? (<button onClick={() => setEditingItem(null)} className="text-sm text-gray-500 hover:underline">لغو</button>) : (<button onClick={() => setEditingItem(item)} className="text-sm text-indigo-500 hover:underline">ویرایش</button>)}
                                    <button onClick={() => requestDeleteItem(item)} disabled={isLoading} className="text-sm text-red-500 hover:underline">حذف</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };
        
        const AssignAttributesModal = ({ isOpen, onClose, category, allAttributes, onSave }) => {
            const [selectedAttributes, setSelectedAttributes] = React.useState(new Set());
            const [isLoading, setIsLoading] = React.useState(true);

            React.useEffect(() => {
                if (isOpen) {
                    setIsLoading(true);
                    supabaseClient.from('category_propertykey').select('propertykey_id').eq('category_id', category.id)
                        .then(({ data, error }) => {
                            if(error) console.error(error);
                            else { setSelectedAttributes(new Set(data.map(item => item.propertykey_id))); }
                            setIsLoading(false);
                        });
                }
            }, [isOpen, category]);

            const handleToggle = (attributeId) => {
                setSelectedAttributes(prev => { const newSet = new Set(prev); if (newSet.has(attributeId)) { newSet.delete(attributeId); } else { newSet.add(attributeId); } return newSet; });
            };

            const handleSave = async () => {
                setIsLoading(true);
                await supabaseClient.from('category_propertykey').delete().eq('category_id', category.id);
                const toInsert = Array.from(selectedAttributes).map(propId => ({ category_id: category.id, propertykey_id: propId }));
                if (toInsert.length > 0) { await supabaseClient.from('category_propertykey').insert(toInsert); }
                onSave();
                onClose();
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title={`مدیریت ویژگی‌های دسته‌بندی: ${category?.title}`}>
                    {isLoading ? <p>در حال بارگذاری...</p> : (
                        <div className="space-y-2 max-h-96 overflow-y-auto">
                            {allAttributes.map(attr => (
                                <label key={attr.id} className="flex items-center p-2 rounded-md hover:bg-gray-100 dark:hover:bg-gray-700">
                                    <input type="checkbox" className="ml-3 h-4 w-4 rounded" checked={selectedAttributes.has(attr.id)} onChange={() => handleToggle(attr.id)} />
                                    <span>{attr.title}</span>
                                </label>
                            ))}
                        </div>
                    )}
                    <div className="flex justify-end gap-3 pt-4 mt-4 border-t border-gray-200 dark:border-gray-600">
                        <button onClick={onClose} className="bg-gray-200 dark:bg-gray-600 text-gray-800 dark:text-white py-2 px-4 rounded-lg">انصراف</button>
                        <button onClick={handleSave} disabled={isLoading} className="bg-indigo-600 text-white py-2 px-4 rounded-lg disabled:bg-indigo-400">ذخیره تغییرات</button>
                    </div>
                </Modal>
            );
        };
        
        const Pagination = ({ currentPage, totalPages, onPageChange }) => {
            if (totalPages <= 1) return null;
            const pageNumbers = [];
            for (let i = 1; i <= totalPages; i++) { pageNumbers.push(i); }

            return (
                <nav className="flex justify-center items-center gap-2">
                    <button onClick={() => onPageChange(currentPage - 1)} disabled={currentPage === 1} className="px-3 py-1 rounded-md bg-white dark:bg-gray-700 disabled:opacity-50">قبلی</button>
                    {pageNumbers.map(number => (
                        <button key={number} onClick={() => onPageChange(number)} className={`px-3 py-1 rounded-md ${currentPage === number ? 'bg-indigo-600 text-white' : 'bg-white dark:bg-gray-700'}`}>{number}</button>
                    ))}
                    <button onClick={() => onPageChange(currentPage + 1)} disabled={currentPage === totalPages} className="px-3 py-1 rounded-md bg-white dark:bg-gray-700 disabled:opacity-50">بعدی</button>
                </nav>
            );
        };

        const TableSkeleton = ({ columns = 8, rows = 5 }) => (
            <tbody>
                {[...Array(rows)].map((_, i) => (
                    <tr key={i} className="border-b border-gray-200 dark:border-gray-700">
                        {[...Array(columns)].map((_, j) => (
                            <td key={j} className="p-3">
                                <div className="h-4 bg-gray-200 dark:bg-gray-700 rounded relative overflow-hidden">
                                     <div className="absolute inset-0 transform -translate-x-full bg-gradient-to-r from-transparent via-gray-300 dark:via-gray-600 to-transparent shimmer animate-[shimmer_1.5s_infinite]"></div>
                                </div>
                            </td>
                        ))}
                    </tr>
                ))}
            </tbody>
        );

        // ==================================================
        // The Standalone Component
        // ==================================================
        const ProductManagement = () => {
            const [products, setProducts] = React.useState([]);
            const [appData, setAppData] = React.useState({ categories: [], brands: [], propertyKeys: [] });
            const [isLoading, setIsLoading] = React.useState(true);
            const [activeTab, setActiveTab] = React.useState('products');

            // Filters, Sort, and Pagination state
            const [searchTerm, setSearchTerm] = React.useState('');
            const [categoryFilter, setCategoryFilter] = React.useState('');
            const [showNoSupplier, setShowNoSupplier] = React.useState(false);
            const [currentPage, setCurrentPage] = React.useState(1);
            const [totalProducts, setTotalProducts] = React.useState(0);
            const [sortConfig, setSortConfig] = React.useState({ key: 'id', direction: 'desc' });
            const [itemsPerPage, setItemsPerPage] = React.useState(100);

            // Modals state
            const [isProductModalOpen, setIsProductModalOpen] = React.useState(false);
            const [editingProduct, setEditingProduct] = React.useState(null);
            const [isAssignModalOpen, setIsAssignModalOpen] = React.useState(false);
            const [selectedCategory, setSelectedCategory] = React.useState(null);
            const [confirmState, setConfirmState] = React.useState({ isOpen: false, onConfirm: null, message: '' });
            const [isDetailsModalOpen, setIsDetailsModalOpen] = React.useState(false);
            const [viewingProduct, setViewingProduct] = React.useState(null);

            const fetchBaseData = async () => {
                const [categoryRes, brandRes, propKeyRes] = await Promise.all([
                    supabaseClient.from('productcategory').select('*').order('title'),
                    supabaseClient.from('brand').select('*').order('title'),
                    supabaseClient.from('propertykey').select('*').order('title')
                ]);
                setAppData({ 
                    categories: categoryRes.data || [], 
                    brands: brandRes.data || [],
                    propertyKeys: propKeyRes.data || []
                });
            };

            const fetchProducts = React.useCallback(async () => {
                setIsLoading(true);
                
                let query = supabaseClient.from('product').select(`*, productcategory(id, title), brand(id, title), supplierstock(*, profiles:supplieruserid(fullname)), productproperty(*, propertykey(*))`, { count: 'exact' });
                
                if (searchTerm) { query = query.ilike('title', `%${searchTerm}%`); }
                if (categoryFilter) { query = query.eq('productcategoryid', categoryFilter); }
                if (showNoSupplier) { query = query.is('supplierstock', null); }

                query = query.order(sortConfig.key, { ascending: sortConfig.direction === 'asc' });

                const from = (currentPage - 1) * itemsPerPage;
                const to = from + itemsPerPage - 1;
                query = query.range(from, to);

                const { data, error, count } = await query;
                
                if (error) { console.error("Error fetching products", error); } 
                else { setProducts(data || []); setTotalProducts(count || 0); }
                
                setIsLoading(false);
            }, [currentPage, sortConfig, searchTerm, categoryFilter, showNoSupplier, itemsPerPage]);


            React.useEffect(() => { fetchBaseData(); }, []);
            React.useEffect(() => { fetchProducts(); }, [fetchProducts]);
            
            const handleSort = (key) => {
                setSortConfig(prev => ({
                    key,
                    direction: prev.key === key && prev.direction === 'asc' ? 'desc' : 'asc'
                }));
                 setCurrentPage(1);
            };

            const handleOpenProductModal = (product = null) => { setEditingProduct(product); setIsProductModalOpen(true); };
            const handleCloseProductModal = () => { setIsProductModalOpen(false); setEditingProduct(null); };
            
            const handleOpenDetailsModal = (product) => { setViewingProduct(product); setIsDetailsModalOpen(true); };
            const handleCloseDetailsModal = () => { setViewingProduct(null); setIsDetailsModalOpen(false); };

            const handleManageAttributes = (category) => { setSelectedCategory(category); setIsAssignModalOpen(true); };
            const closeConfirmModal = () => setConfirmState({ isOpen: false, onConfirm: null, message: '' });

            const TabButton = ({ tabName, currentTab, setTab, children }) => (
                <button onClick={() => setTab(tabName)} className={`px-4 py-2 text-sm font-semibold border-b-2 transition-colors duration-200 ${tabName === currentTab ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 hover:text-gray-800 dark:hover:text-gray-200'}`}>
                    {children}
                </button>
            );
            
            const SortableHeader = ({ children, columnKey }) => {
                const isSorted = sortConfig.key === columnKey;
                const icon = isSorted ? (sortConfig.direction === 'asc' ? '▲' : '▼') : '';
                return (
                    <th className="p-3 cursor-pointer select-none" onClick={() => handleSort(columnKey)}>
                        {children} <span className="text-xs">{icon}</span>
                    </th>
                )
            };

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <div className="flex flex-col md:flex-row justify-between md:items-center mb-2 gap-4">
                        <h1 className="text-2xl md:text-3xl font-bold text-gray-900 dark:text-white">مدیریت محصولات</h1>
                        {activeTab === 'products' && (
                            <button onClick={() => handleOpenProductModal()} className="w-full md:w-auto bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
                                افزودن محصول جدید
                            </button>
                        )}
                    </div>
                    
                    <div className="border-b border-gray-200 dark:border-gray-700 mb-6">
                        <nav className="-mb-px flex space-x-4 space-x-reverse">
                            <TabButton tabName="products" currentTab={activeTab} setTab={setActiveTab}>محصولات</TabButton>
                            <TabButton tabName="categories" currentTab={activeTab} setTab={setActiveTab}>دسته‌بندی‌ها</TabButton>
                            <TabButton tabName="brands" currentTab={activeTab} setTab={setActiveTab}>برندها</TabButton>
                            <TabButton tabName="attributes" currentTab={activeTab} setTab={setActiveTab}>ویژگی‌ها</TabButton>
                        </nav>
                    </div>

                    {activeTab === 'products' && (
                        <div>
                             <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow mb-6">
                                 <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-center">
                                     <input type="text" placeholder="جستجوی نام محصول..." value={searchTerm} onChange={(e) => {setSearchTerm(e.target.value); setCurrentPage(1);}} className="lg:col-span-2 w-full p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"/>
                                     <select value={categoryFilter} onChange={e => {setCategoryFilter(e.target.value); setCurrentPage(1);}} className="w-full p-2 bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg">
                                         <option value="">همه دسته‌بندی‌ها</option>
                                         {appData.categories.map(c => <option key={c.id} value={c.id}>{c.title}</option>)}
                                     </select>
                                     <div className="flex items-center">
                                         <input type="checkbox" id="showNoSupplier" checked={showNoSupplier} onChange={e => {setShowNoSupplier(e.target.checked); setCurrentPage(1);}} className="ml-2 h-4 w-4 rounded" />
                                         <label htmlFor="showNoSupplier" className="text-sm font-medium">بدون تامین‌کننده</label>
                                     </div>
                                 </div>
                             </div>

                            <div className="bg-white dark:bg-gray-800 p-4 rounded-lg shadow overflow-x-auto">
                                <table className="w-full text-right min-w-[800px]">
                                    <thead>
                                        <tr className="border-b border-gray-200 dark:border-gray-700">
                                            <SortableHeader columnKey="id">کد بازاریو</SortableHeader>
                                            <SortableHeader columnKey="title">نام محصول</SortableHeader>
                                            <th className="p-3">کد تلگرام</th>
                                            <th className="p-3">دسته‌بندی</th>
                                            <th className="p-3">برند</th>
                                            <th className="p-3">وضعیت تامین</th>
                                            <SortableHeader columnKey="createdat">تاریخ ثبت</SortableHeader>
                                            <th className="p-3">عملیات</th>
                                        </tr>
                                    </thead>
                                    {isLoading ? <TableSkeleton /> : (
                                        <tbody>
                                            {products.length === 0 ? (
                                                <tr><td colSpan="8" className="text-center p-4">محصولی با این فیلترها یافت نشد.</td></tr>
                                            ) : (
                                                products.map(product => {
                                                    const telegramCode = product.productproperty.find(p => p.propertykey?.title === 'کد کالا (تلگرام)')?.value || '-';
                                                    return (
                                                        <tr key={product.id} className={`border-b border-gray-200 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-700/50`}>
                                                            <td className="p-3 font-mono">{product.id}</td>
                                                            <td className="p-3 font-semibold">{product.title}</td>
                                                            <td className="p-3 font-mono">{telegramCode}</td>
                                                            <td className="p-3">{product.productcategory?.title || '-'}</td>
                                                            <td className="p-3">{product.brand?.title || '-'}</td>
                                                            <td className="p-3">
                                                                {product.supplierstock.length > 0 ? 
                                                                    <span className="px-2 py-1 text-xs rounded-full bg-green-200 text-green-800 dark:bg-green-900 dark:text-green-200">دارد</span> :
                                                                    <span className="px-2 py-1 text-xs rounded-full bg-yellow-200 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">ندارد</span>
                                                                }
                                                            </td>
                                                            <td className="p-3 font-mono text-sm">{toJalaali(product.createdat)}</td>
                                                            <td className="p-3 flex items-center space-x-3 space-x-reverse">
                                                                <button onClick={() => handleOpenDetailsModal(product)} className="text-green-600 dark:text-green-400 hover:text-green-800">جزئیات</button>
                                                                <button onClick={() => handleOpenProductModal(product)} className="text-indigo-600 dark:text-indigo-400 hover:text-indigo-800">ویرایش</button>
                                                            </td>
                                                        </tr>
                                                    );
                                                })
                                            )}
                                        </tbody>
                                    )}
                                </table>
                                <div className="flex flex-col md:flex-row justify-between items-center mt-6 gap-4">
                                     <div className="flex items-center gap-2 text-sm text-gray-600 dark:text-gray-400">
                                        <span>نمایش</span>
                                         <select 
                                             value={itemsPerPage} 
                                             onChange={e => {
                                                 setItemsPerPage(Number(e.target.value));
                                                 setCurrentPage(1);
                                             }}
                                             className="p-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg"
                                         >
                                             <option value="15">15</option>
                                             <option value="25">25</option>
                                             <option value="50">50</option>
                                             <option value="100">100</option>
                                         </select>
                                         <span>ردیف از {totalProducts} رکورد</span>
                                     </div>
                                     <Pagination currentPage={currentPage} totalPages={Math.ceil(totalProducts / itemsPerPage)} onPageChange={setCurrentPage} />
                                </div>
                            </div>
                        </div>
                    )}

                    {activeTab === 'categories' && ( <GenericManager onSave={fetchBaseData} title="دسته‌بندی" tableName="productcategory" items={appData.categories} confirmModal={setConfirmState} onManageAttributes={handleManageAttributes} attributeLabel="مدیریت ویژگی‌ها"/> )}
                    {activeTab === 'brands' && ( <GenericManager onSave={fetchBaseData} title="برند" tableName="brand" items={appData.brands} confirmModal={setConfirmState}/> )}
                    {activeTab === 'attributes' && ( <GenericManager onSave={fetchBaseData} title="ویژگی" tableName="propertykey" items={appData.propertyKeys} confirmModal={setConfirmState}/> )}
                    
                    {isProductModalOpen && <ProductForm isOpen={isProductModalOpen} onClose={handleCloseProductModal} onSave={fetchProducts} product={editingProduct} appData={appData} />}
                    {isDetailsModalOpen && <ProductDetailsModal isOpen={isDetailsModalOpen} onClose={handleCloseDetailsModal} product={viewingProduct} />}
                    {isAssignModalOpen && <AssignAttributesModal isOpen={isAssignModalOpen} onClose={() => setIsAssignModalOpen(false)} category={selectedCategory} allAttributes={appData.propertyKeys} onSave={fetchBaseData} />}
                    <ConfirmModal isOpen={confirmState.isOpen} onClose={closeConfirmModal} onConfirm={confirmState.onConfirm} title="تایید عملیات" message={confirmState.message} />
                </div>
            );
        };

        const App = () => ( <div className="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 min-h-screen"><ProductManagement /></div> );
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>

